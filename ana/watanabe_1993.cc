///////////////////////////////////////////////////////////////////////////////
// tabulated DIO spectra from Watanabe'1993 - so far, Pb-208 and O-16
///////////////////////////////////////////////////////////////////////////////
#include "ana/watanabe_1993.hh"
//-----------------------------------------------------------------------------
watanabe_1993::watanabe_1993() {

  fFun2 = new TF1("f_fitf2", watanabe_1993::fitf2,59,91,4);
  fFun3 = new TF1("f_fitf3", watanabe_1993::fitf3,59,91,4);

//-----------------------------------------------------------------------------  
//  59-76 MeV (for fitting purposes, data multiplied by *1e8)
// p0                        =      1464.97   +/-   2.05112     
// p1                        =    0.0336297   +/-   0.0212911   
// p2                        =     0.396386   +/-   0.0150705   
// p3                        =      3.80298   +/-   0.00434531  
//
  fFun2->SetParameter(0, 1.465e3);
  fFun2->SetParameter(1, 0.0336297);
  fFun2->SetParameter(2, 0.396386 );
  fFun2->SetParameter(3, 3.80298  );
//-----------------------------------------------------------------------------
// 74-91 MeV, data multiplied by 1.e12
//  p0 =  14860.3   +/-   0.218653    
//  p1 =  1.12665   +/-   4.5284e-05  
//  p2 =  1.97235   +/-   3.49924e-05 
//  p3 =  5.91764   +/-   2.73401e-05 
//-----------------------------------------------------------------------------
  fFun3->SetParameter(0, 1.486e4);
  fFun3->SetParameter(1, 1.12665);
  fFun3->SetParameter(2, 1.97235);
  fFun3->SetParameter(3, 5.91764);
//-----------------------------------------------------------------------------
// init spectra
//-----------------------------------------------------------------------------
  init_dio_spectrum_Pb();
  init_dio_spectrum_O16();
}

//-----------------------------------------------------------------------------
watanabe_1993::~watanabe_1993() {
  delete fDioPb;
  delete fDioPb2;
  delete fDioPb3;

  delete fFun2;
  delete fFun3;
}

//-----------------------------------------------------------------------------
// p0                        =      13551.9   +/-   0.0614322   
// p1                        =    0.0941494   +/-   6.51217e-06 
// p2                        =      0.23575   +/-   6.73037e-06 
// p3                        =     0.610469   +/-   7.00915e-06 
// p4                        =      4.48475   +/-   7.0041e-06  
//-----------------------------------------------------------------------------
double watanabe_1993::fitf2(double* X, double* P) {

  double dx = (X[0]-67.5)/10;

  double v  = P[1]*dx*dx*dx + P[2]*dx*dx + P[3]*dx;
    
  double f = P[0]*TMath::Exp(-v);

  return f;
}

//-----------------------------------------------------------------------------
// p0                        =      13551.9   +/-   0.0614322   
// p1                        =    0.0941494   +/-   6.51217e-06 
// p2                        =      0.23575   +/-   6.73037e-06 
// p3                        =     0.610469   +/-   7.00915e-06 
// p4                        =      4.48475   +/-   7.0041e-06
//-----------------------------------------------------------------------------
double watanabe_1993::fitf3(double* X, double* P) {

  double dx = (X[0]-82.5)/10;
  //  double dx2 = dx*dx;

  double v  = P[1]*dx*dx*dx + P[2]*dx*dx + P[3]*dx;
    
  double f = P[0]*TMath::Exp(-v);

  return f;
}

//-----------------------------------------------------------------------------
// Watanabe_1993'2003 Pb spectrum
//-----------------------------------------------------------------------------
void watanabe_1993::init_dio_spectrum_Pb() {
  
  float data[] = {
		  1.0,   0.653e-3,
		  2.0,   0.179e-2,
		  3.0,   0.319e-2,
		  4.0,   0.471e-2,
		  5.0,   0.629e-2,
		  6.0,   0.788e-2,
		  7.0,   0.945e-2,
		  8.0,   0.110e-1,
		  9.0,   0.125e-1,
		  10.0,  0.139e-1,
		  11.0,  0.152e-1,
		  12.0,  0.165e-1,
		  13.0,  0.177e-1,
		  14.0,  0.189e-1,
		  15.0,  0.200e-1,
		  16.0,  0.210e-1,
		  17.0,  0.220e-1,
		  18.0,  0.229e-1,
		  19.0,  0.237e-1,
		  20.0,  0.244e-1,
		  21.0,  0.251e-1,
		  22.0,  0.256e-1,
		  23.0,  0.261e-1,
		  24.0,  0.265e-1,
		  25.0,  0.268e-1,
		  26.0,  0.269e-1,
		  27.0,  0.270e-1,
		  28.0,  0.269e-1,
		  29.0,  0.267e-1,
		  30.0,  0.264e-1,
		  31.0,  0.259e-1,
		  32.0,  0.253e-1,
		  33.0,  0.246e-1,
		  34.0,  0.237e-1,
		  35.0,  0.226e-1,
		  36.0,  0.215e-1,
		  37.0,  0.202e-1,
		  38.0,  0.188e-1,
		  39.0,  0.174e-1,
		  40.0,  0.159e-1,
		  41.0,  0.144e-1,
		  42.0,  0.128e-1,
		  43.0,  0.113e-1,
		  44.0,  0.987e-2,
		  45.0,  0.850e-2,
		  46.0,  0.722e-2,
		  47.0,  0.606e-2,
		  48.0,  0.501e-2,
		  49.0,  0.409e-2,
		  50.0,  0.330e-2,
		  51.0,  0.263e-2,
		  52.0,  0.207e-2,
		  53.0,  0.161e-2,
		  54.0,  0.124e-2,
		  55.0,  0.940e-3,
		  56.0,  0.707e-3,
		  57.0,  0.527e-3,
		  58.0,  0.389e-3,
		  59.0,  0.285e-3,
		  60.0,  0.206e-3,
		  65.0,  0.370e-4,
		  70.0,  0.552e-5,
		  75.0,  0.667e-6,
		  80.0,  0.587e-7,
		  85.0,  0.294e-8,
		  90.0,  0.360e-10,
		  -1
  };
  
  float x[100], y[100], y2[100], y3[100];
//-----------------------------------------------------------------------------
// make sure the DIO spectrum is properly normalized
// Watanabe_1993 spectrum is normalized ot the unity integral
//-----------------------------------------------------------------------------
  double fint(0);
  for (int i=0; data[2*i] > 0; i++) {
    float x = data[2*i  ];
    if (x >= 75) {
      fint += data[2*i+1];
    }
  }
  
  int npt = 0;

  for (int i=0; data[2*i] > 0; i++) {
    x[npt]  = data[2*i  ];
    y[npt]  = data[2*i+1];
    y2[npt] = data[2*i+1]*1.e8;
    y3[npt] = data[2*i+1]*1.e12;
    npt++;
  }

  fDioPb = new TGraph(npt,x,y);
  fDioPb->SetName ("DioPb");
  fDioPb->SetTitle("DioPb");
  fDioPb->SetMarkerStyle(20);
  fDioPb->SetMarkerSize(0.9);
					// for fitting
  fDioPb2 = new TGraph(npt,x,y2);
  fDioPb2->SetName ("DioPb2");
  fDioPb2->SetTitle("DioPb2");
  fDioPb2->SetMarkerStyle(20);
  fDioPb2->SetMarkerSize(0.9);

  fDioPb3 = new TGraph(npt,x,y3);
  fDioPb3->SetName ("DioPb3");
  fDioPb3->SetTitle("DioPb3");
  fDioPb3->SetMarkerStyle(20);
  fDioPb3->SetMarkerSize(0.9);
}


//-----------------------------------------------------------------------------
// Watanabe_1993 O16
//-----------------------------------------------------------------------------
void watanabe_1993::init_dio_spectrum_O16() {
  
  float data[] = {
		  1.0,   0.427e-4,
		  2.0,   0.182e-3,
		  3.0,   0.403e-3,
		  4.0,   0.701e-3,
		  5.0,   0.107e-2,
		  6.0,   0.150e-2,
		  7.0,   0.200e-2,
		  8.0,   0.256e-2,
		  9.0,   0.317e-2,
		  10.0,  0.384e-2,
		  11.0,  0.456e-2,
		  12.0,  0.532e-2,
		  13.0,  0.613e-2,
		  14.0,  0.698e-2,
		  15.0,  0.786e-2,
		  16.0,  0.878e-2,
		  17.0,  0.973e-2,
		  18.0,  0.107e-1,
		  19.0,  0.117e-1,
		  20.0,  0.127e-1,
		  21.0,  0.138e-1,
		  22.0,  0.148e-1,
		  23.0,  0.159e-1,
		  24.0,  0.170e-1,
		  25.0,  0.181e-1,
		  26.0,  0.192e-1,
		  27.0,  0.202e-1,
		  28.0,  0.213e-1,
		  29.0,  0.224e-1,
		  30.0,  0.234e-1,
		  31.0,  0.245e-1,
		  32.0,  0.255e-1,
		  33.0,  0.265e-1,
		  34.0,  0.275e-1,
		  35.0,  0.285e-1,
		  36.0,  0.294e-1,
		  37.0,  0.303e-1,
		  38.0,  0.312e-1,
		  39.0,  0.320e-1,
		  40.0,  0.327e-1,
		  41.0,  0.335e-1,
		  42.0,  0.341e-1,
		  43.0,  0.348e-1,
		  44.0,  0.353e-1,
		  45.0,  0.358e-1,
		  46.0,  0.362e-1,
		  47.0,  0.364e-1,
		  48.0,  0.364e-1,
		  49.0,  0.358e-1,
		  50.0,  0.340e-1,
		  51.0,  0.293e-1,
		  52.0,  0.207e-1,
		  53.0,  0.108e-1,
		  54.0,  0.434e-2,
		  55.0,  0.158e-2,
		  56.0,  0.587e-3,
		  57.0,  0.235e-3,
		  58.0,  0.102e-3,
		  59.0,  0.476e-4,
		  60.0,  0.238e-4,
		  65.0,  0.144e-5,
		  70.0,  0.163e-6,
		  75.0,  0.244e-7,
		  80.0,  0.400e-8,
		  85.0,  0.622e-9,
		  90.0,  0.774e-10,
		  95.0,  0.570e-11,
		  100.0, 0.973e-13,
		  -1
  };
  
  float x[100], y[100];
//-----------------------------------------------------------------------------
// make sure the DIO spectrum is properly normalized
// Watanabe spectrum is normalized ot the unity integral
//-----------------------------------------------------------------------------
  double fint(0);
  for (int i=0; data[2*i] > 0; i++) {
    float x = data[2*i  ];
    if (x >= 75) {
      fint += data[2*i+1];
    }
  }
  
  int npt = 0;

  for (int i=0; data[2*i] > 0; i++) {
    x[npt] = data[2*i  ];
    y[npt] = data[2*i+1];
    npt++;
  }

  fDioO16 = new TGraph(npt,x,y);
}

//-----------------------------------------------------------------------------
// fill histogram with the spectrum data - this is a full DIO spectrum,
// can be normalized to 1
//-----------------------------------------------------------------------------
int watanabe_1993::get_dio_spectrum(const char* Nucleus, TH1F* Hist) {
  TString nucleus(Nucleus);

  int    nb  = Hist->GetNbinsX();
  //  double wid = Hist->GetBinWidth(1);

  Hist->Reset();
  
  if (nucleus == "Pb208") {
    for (int i=0; i<nb; i++) {
      double x = Hist->GetBinCenter(i+1);
      double y;
      if (x < 60) {
	// linear interpolation from Watanabe
	y = fDioPb->Eval(x);
	Hist->SetBinContent(i+1,y);
	Hist->SetBinError  (i+1,0);
      }
      else if (x < 76) {
	// fFun2
	y = fFun2->Eval(x)*1.e-8;
	Hist->SetBinContent(i+1,y);
	Hist->SetBinError  (i+1,0);
      }
      else if (x < 91) {
	// fFun3
	y = fFun3->Eval(x)*1.e-12;
	Hist->SetBinContent(i+1,y);
	Hist->SetBinError  (i+1,0);
      }
    }
  }

  return 0;
}
